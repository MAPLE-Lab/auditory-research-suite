<?xml version="1.0"?>
<project name="MapleLab" default="all">
	<!-- TODO: Refactor these experiment builds into common file w/ simple target differentiation. -->
    <description>
	     Create project deployment objects.
    </description>

	<tstamp>
		<format property="DTS" pattern="DDD.HH.mm.ss"/>
	</tstamp>
	
    <property name="src" value="${basedir}" />
    <property name="build" value="${basedir}" />
	
    <property name="si.jar" value="si.jar" />
	
	<property name="si.dist.dir" value="${build}/www/si" />
    <property name="si.jar.path" location="${si.dist.dir}/${si.jar}"/>	
	
	<property name="si.vprops" value="${basedir}/edu/mcmaster/maplelab/si/si.version.properties"/>
	
    <patternset id="common.classes">
    	<include name="edu/mcmaster/maplelab/common/*.class" />
    	<include name="edu/mcmaster/maplelab/common/**/*.class" />
        <include name="edu/mcmaster/maplelab/common/**/*.png" />
        <include name="edu/mcmaster/maplelab/common/**/*.properties" />      	
    </patternset>

    <patternset id="av.classes">
	    <include name="edu/mcmaster/maplelab/av/*.class" />
	    <include name="edu/mcmaster/maplelab/av/**/*.class" />
        <include name="edu/mcmaster/maplelab/av/**/*.png" />  
        <include name="edu/mcmaster/maplelab/av/*.properties" />  
    </patternset>

    <patternset id="si.classes">
	    <include name="edu/mcmaster/maplelab/si/*.class" />
	    <include name="edu/mcmaster/maplelab/si/**/*.class" />
        <include name="edu/mcmaster/maplelab/si/**/*.png" />  
        <include name="edu/mcmaster/maplelab/si/*.properties" />  
    </patternset>
	
	<path id="used.jars.path">
        <fileset dir="lib">
	        <include name="junit-4.1.jar" />
        	<include name="miglayout-4.0.jar" />
        	<include name="jogl.all.jar" />
        	<include name="joal.jar" />
        	<include name="gluegen-rt.jar" />
        </fileset>
    </path>	
	
    <target name="all" depends="si"/> 
	
	<target name="cache_version.update">
		<!-- Update applet cache number to browser knows to re-download it -->
    	<replaceregexp byline="yes">
    		<regexp pattern="^.*cache_version.*$"/>
    		<substitution expression="    &lt;param name=&quot;cache_version&quot; value=&quot;${DTS}&quot;/&gt;"/>
    		
    		<fileset dir="${basedir}">
    			<include name="www/**/*.html"/>
			</fileset>
    		<!--
    		<fileset dir="${iat.destdir}">
	    		<include name="mondrian.jsp" if="iat.exists"/>
    		</fileset>
    		-->
    	</replaceregexp>		
	</target>

	
	<target name="si" depends="si.jar">
	    <ant antfile="${basedir}/app/si-app-build.xml" dir="${basedir}/app" />
	</target>
	
    <target name="si.jar" depends="si.version, compile">
		<jar destfile="${si.jar.path}">
            <fileset dir="${build}">
                <patternset refid="common.classes" />
                <patternset refid="av.classes" />
                <patternset refid="si.classes" />
            </fileset>
            <manifest>
                    <attribute name="Built-By" value="${user.name}" />
            </manifest>			
		</jar>
    </target>	
	
	<!-- Get the SVN build version. -->
	<target name="svn.version" if="is.svn">
		<exec executable="svnversion">
        	<redirector outputproperty="build-num">
        		<outputfilterchain>
        			<tokenfilter>
        				<!-- Strip anything after the first integer -->
        				<trim/>
                        <replaceregex pattern="^([0-9]+).*$" replace="\1"/>
                        <replaceregex pattern="^exported$" replace="-1"/>
        			</tokenfilter>
        		</outputfilterchain>
        	</redirector>
    	</exec>
	</target>
	
	<!-- Get the SVN build version from git. -->
	<target name="git.version" unless="is.svn">
		<exec executable="git">
			<arg value="svn" />
			<arg value="info" />
        	<redirector outputproperty="build-num">
        		<outputfilterchain>
        			<linecontains>
					  	 <contains value="Revision:"/>
				 	</linecontains>
        			<tokenfilter>
        				<!-- Strip anything but the number. -->
        				<trim/>
        				<replaceregex pattern="Revision: " replace=""/>
        			</tokenfilter>
        		</outputfilterchain>
        	</redirector>
    	</exec>
	</target>

	<available property="is.svn" file=".svn" type="dir" />
	<target name="si.version" depends="svn.version, git.version" >
		
		<echo>Got build num.</echo>
		<echo>Got build num=${build-num}.</echo>
		
		<!-- Write the property file using the current date and time. -->
		<propertyfile file="${si.vprops}" comment="Sensory Integration Experiment Build Information File">
			<entry key="buildVersion" type="int" value="${build-num}"/>
			<entry key="buildDate" type="date" value="now" pattern="yyyy-MM-dd HH-mm-ss zzz"/>
		</propertyfile>
	</target>
	
    <target name="compile">
	    <javac nowarn="yes" source="1.6" srcdir="${src}" destdir="${build}">
    		<include name="edu/mcmaster/maplelab/common/**/*.java"/>
	    	<include name="edu/mcmaster/maplelab/si/**/*.java"/>
	    	<exclude name="edu/mcmaster/maplelab/toj/*.java" />
	    	<exclude name="edu/mcmaster/maplelab/toj/**/*.java" />
	    	<exclude name="edu/mcmaster/maplelab/rhythm/*.java" />
	    	<exclude name="edu/mcmaster/maplelab/rhythm/**/*.java" />
	    	<classpath refid="used.jars.path" />
        </javac>
    </target>	
	
	<target name="clean">
		<delete dir="edu/mcmaster/maplelab">
			<include name="*.class"/>
			<include name="./**/*.class"/>
		</delete>
	</target>

</project>
